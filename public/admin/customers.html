<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customers | Bubblebee Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/admin/admin.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <a href="/" class="sidebar-logo">
                <div class="sidebar-logo-icon">üêù</div>
                <span class="sidebar-logo-text">Bubblebee</span>
            </a>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-label">Overview</div>
                    <a href="/admin/dashboard.html" class="nav-link" data-page="dashboard">
                        <span class="nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-label">Operations</div>
                    <a href="/admin/bookings.html" class="nav-link" data-page="bookings">
                        <span class="nav-icon">üìÖ</span>
                        <span>Bookings</span>
                    </a>
                    <a href="/admin/customers.html" class="nav-link active" data-page="customers">
                        <span class="nav-icon">üë•</span>
                        <span>Customers</span>
                    </a>
                    <a href="/admin/schedule.html" class="nav-link" data-page="schedule">
                        <span class="nav-icon">üóìÔ∏è</span>
                        <span>Schedule</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-label">Settings</div>
                    <a href="/admin/theme.html" class="nav-link" data-page="theme">
                        <span class="nav-icon">üé®</span>
                        <span>Site Theme</span>
                    </a>
                </div>
            </nav>
            
            <div class="sidebar-user">
                <div class="sidebar-user-info">
                    <div class="sidebar-user-avatar" id="user-avatar">A</div>
                    <div>
                        <div class="sidebar-user-name" id="user-name">Admin</div>
                        <div class="sidebar-user-role" id="user-role">Administrator</div>
                    </div>
                </div>
                <button class="btn btn-secondary btn-block" onclick="logout()">Logout</button>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <header class="page-header">
                <div>
                    <h1>Customers</h1>
                    <p class="page-subtitle">View and manage your customer database.</p>
                </div>
                <div class="header-actions">
                    <div class="search-input">
                        <input type="text" id="search-input" placeholder="Search customers..." style="padding: 0.5rem 1rem 0.5rem 2.5rem; border-radius: 8px; border: 1px solid #eee; width: 250px;">
                    </div>
                </div>
            </header>
            
            <div class="card">
                <div class="card-body" style="padding: 0;">
                    <div class="table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Contact</th>
                                    <th>Location</th>
                                    <th>Total Spent</th>
                                    <th>Jobs</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customers-table">
                                <tr>
                                    <td colspan="6" class="loading">Loading customers...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                <div class="page-info" id="page-info">Showing 0 customers</div>
            </div>
        </main>
    </div>
    
    <!-- Customer Detail Modal -->
    <div class="modal" id="customer-modal">
        <div class="modal-content" style="max-width: 700px;">
            <button class="modal-close" onclick="closeModal('customer-modal')">√ó</button>
            <div id="customer-detail">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>
    
    <script src="/admin/admin.js"></script>
    <script>
        let searchTimeout;
        
        document.addEventListener('DOMContentLoaded', async () => {
            await requireAuth();
            loadUserInfo();
            loadCustomers();
            
            document.getElementById('search-input').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => loadCustomers(e.target.value), 300);
            });
        });
        
        async function loadCustomers(search = '') {
            const tbody = document.getElementById('customers-table');
            
            try {
                const params = new URLSearchParams({ limit: 50 });
                if (search) params.append('search', search);
                
                const { customers, total } = await api(`/api/admin/customers?${params}`);
                
                if (customers.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6">
                                <div class="empty-state">
                                    <div class="empty-icon">üë•</div>
                                    <h3>No customers found</h3>
                                    <p>${search ? 'Try a different search term.' : 'Customers will appear here when they book services.'}</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    document.getElementById('page-info').textContent = 'No customers';
                    return;
                }
                
                tbody.innerHTML = customers.map(c => `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--honey) 0%, var(--honey-dark) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                    ${getInitials(c.first_name, c.last_name)}
                                </div>
                                <div>
                                    <strong>${c.first_name} ${c.last_name}</strong>
                                    <div style="font-size: 0.75rem; color: var(--text-light);">Since ${formatDate(c.created_at)}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>${c.email || 'No email'}</div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">${formatPhone(c.phone) || 'No phone'}</div>
                        </td>
                        <td>
                            <div style="max-width: 180px;">
                                ${c.city || 'Unknown'}${c.state ? ', ' + c.state : ''}
                                ${c.zip_code ? '<div style="font-size: 0.8rem; color: var(--text-light);">' + c.zip_code + '</div>' : ''}
                            </div>
                        </td>
                        <td><strong>${formatCurrency(c.total_spent)}</strong></td>
                        <td>${c.total_jobs || 0}</td>
                        <td class="actions">
                            <button class="btn btn-small btn-secondary" onclick="viewCustomer('${c.id}')">View</button>
                        </td>
                    </tr>
                `).join('');
                
                document.getElementById('page-info').textContent = `Showing ${customers.length} of ${total} customers`;
                
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="6" class="error">Failed to load customers</td></tr>`;
            }
        }
        
        async function viewCustomer(id) {
            openModal('customer-modal');
            const container = document.getElementById('customer-detail');
            container.innerHTML = '<div class="loading">Loading...</div>';
            
            try {
                const customer = await api(`/api/admin/customers/${id}`);
                
                container.innerHTML = `
                    <div class="customer-header">
                        <div class="customer-avatar">${getInitials(customer.first_name, customer.last_name)}</div>
                        <div>
                            <h2 class="customer-name">${customer.first_name} ${customer.last_name}</h2>
                            <div class="customer-meta">Customer since ${formatDate(customer.created_at)}</div>
                            <div class="customer-stats">
                                <div>
                                    <span class="customer-stat-value">${formatCurrency(customer.total_spent)}</span>
                                    <span class="customer-stat-label">Total Spent</span>
                                </div>
                                <div>
                                    <span class="customer-stat-value">${customer.total_jobs || 0}</span>
                                    <span class="customer-stat-label">Jobs</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">Contact Information</h3>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="font-size: 0.8rem; color: var(--text-light);">Email</label>
                                    <div>${customer.email || 'Not provided'}</div>
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: var(--text-light);">Phone</label>
                                    <div>${formatPhone(customer.phone) || 'Not provided'}</div>
                                </div>
                            </div>
                            <div style="margin-top: 1rem;">
                                <label style="font-size: 0.8rem; color: var(--text-light);">Address</label>
                                <div>${customer.address || 'Not provided'}</div>
                                <div>${customer.city || ''}${customer.state ? ', ' + customer.state : ''} ${customer.zip_code || ''}</div>
                            </div>
                            ${customer.notes ? `
                            <div style="margin-top: 1rem;">
                                <label style="font-size: 0.8rem; color: var(--text-light);">Notes</label>
                                <div>${customer.notes}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Booking History</h3>
                        </div>
                        <div class="card-body" style="padding: 0;">
                            ${customer.bookings && customer.bookings.length > 0 ? `
                                <table class="admin-table">
                                    <thead>
                                        <tr>
                                            <th>Service</th>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${customer.bookings.map(b => `
                                            <tr>
                                                <td>${b.service_name || 'Cleaning'}</td>
                                                <td>${formatDate(b.scheduled_date)}</td>
                                                <td>${formatCurrency(b.total_amount)}</td>
                                                <td><span class="badge badge-${b.status}">${b.status}</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : `
                                <div class="empty-state" style="padding: 2rem;">
                                    <p>No booking history yet.</p>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            } catch (err) {
                container.innerHTML = '<div class="error">Failed to load customer details</div>';
            }
        }
    </script>
</body>
</html>
