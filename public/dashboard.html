<!DOCTYPE html>
<html lang="en" data-theme="default" data-texture="none">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Bubblebee Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/admin/admin.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <a href="/" class="sidebar-logo">
                <div class="sidebar-logo-icon">üêù</div>
                <span class="sidebar-logo-text">Bubblebee</span>
            </a>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-label">Overview</div>
                    <a href="/admin/dashboard.html" class="nav-link active" data-page="dashboard">
                        <span class="nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-label">Operations</div>
                    <a href="/admin/bookings.html" class="nav-link" data-page="bookings">
                        <span class="nav-icon">üìÖ</span>
                        <span>Bookings</span>
                        <span class="nav-badge" id="pending-badge" style="display: none;">0</span>
                    </a>
                    <a href="/admin/customers.html" class="nav-link" data-page="customers">
                        <span class="nav-icon">üë•</span>
                        <span>Customers</span>
                    </a>
                    <a href="/admin/schedule.html" class="nav-link" data-page="schedule">
                        <span class="nav-icon">üóìÔ∏è</span>
                        <span>Schedule</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-label">Settings</div>
                    <a href="/admin/theme.html" class="nav-link" data-page="theme">
                        <span class="nav-icon">üé®</span>
                        <span>Site Theme</span>
                    </a>
                </div>
            </nav>
            
            <div class="sidebar-user">
                <div class="sidebar-user-info">
                    <div class="sidebar-user-avatar" id="user-avatar">A</div>
                    <div>
                        <div class="sidebar-user-name" id="user-name">Admin</div>
                        <div class="sidebar-user-role" id="user-role">Administrator</div>
                    </div>
                </div>
                <button class="btn btn-secondary btn-block" onclick="logout()">Logout</button>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <header class="page-header">
                <div>
                    <h1>Dashboard</h1>
                    <p class="page-subtitle">Welcome back! Here's what's happening today.</p>
                </div>
                <div class="header-actions">
                    <a href="/" class="btn btn-secondary" target="_blank">View Site ‚Üí</a>
                </div>
            </header>
            
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon honey">üìÖ</div>
                    <div class="stat-value" id="stat-today">0</div>
                    <div class="stat-label">Today's Bookings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon sage">üìã</div>
                    <div class="stat-value" id="stat-week">0</div>
                    <div class="stat-label">This Week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon honey">üí∞</div>
                    <div class="stat-value" id="stat-month-revenue">$0</div>
                    <div class="stat-label">Revenue This Month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon sage">üë•</div>
                    <div class="stat-value" id="stat-customers">0</div>
                    <div class="stat-label">Total Customers</div>
                </div>
            </div>
            
            <!-- Two Column Layout -->
            <div class="dashboard-grid">
                <!-- Today's Schedule -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Today's Schedule</h2>
                        <a href="/admin/schedule.html" class="btn btn-small btn-secondary">View All</a>
                    </div>
                    <div class="card-body" id="today-schedule">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
                
                <!-- Recent Bookings -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Bookings</h2>
                        <a href="/admin/bookings.html" class="btn btn-small btn-secondary">View All</a>
                    </div>
                    <div class="card-body" id="recent-bookings">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Stats Row -->
            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <h2 class="card-title">Performance Overview</h2>
                </div>
                <div class="card-body">
                    <div class="performance-grid">
                        <div class="performance-item">
                            <div class="performance-value" id="stat-pending">0</div>
                            <div class="performance-label">Pending Bookings</div>
                        </div>
                        <div class="performance-item">
                            <div class="performance-value" id="stat-completed">0</div>
                            <div class="performance-label">Completed This Month</div>
                        </div>
                        <div class="performance-item">
                            <div class="performance-value" id="stat-total-revenue">$0</div>
                            <div class="performance-label">Total Revenue</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="/admin/admin.js"></script>
    <script>
        // Load dashboard data
        document.addEventListener('DOMContentLoaded', async () => {
            await requireAuth();
            loadUserInfo();
            loadStats();
            loadTodaySchedule();
            loadRecentBookings();
        });
        
        async function loadStats() {
            try {
                const stats = await api('/api/admin/stats');
                
                document.getElementById('stat-today').textContent = stats.todayBookings;
                document.getElementById('stat-week').textContent = stats.weekBookings;
                document.getElementById('stat-month-revenue').textContent = formatCurrency(stats.monthRevenue);
                document.getElementById('stat-customers').textContent = stats.totalCustomers;
                document.getElementById('stat-pending').textContent = stats.pendingBookings;
                document.getElementById('stat-completed').textContent = stats.completedThisMonth;
                document.getElementById('stat-total-revenue').textContent = formatCurrency(stats.totalRevenue);
                
                // Update pending badge
                if (stats.pendingBookings > 0) {
                    const badge = document.getElementById('pending-badge');
                    badge.textContent = stats.pendingBookings;
                    badge.style.display = 'flex';
                }
            } catch (err) {
                console.error('Failed to load stats:', err);
            }
        }
        
        async function loadTodaySchedule() {
            const container = document.getElementById('today-schedule');
            
            try {
                const bookings = await api('/api/admin/schedule/today');
                
                if (bookings.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìÖ</div>
                            <h3>No bookings today</h3>
                            <p>Enjoy the break!</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = bookings.map(b => `
                    <div class="schedule-item">
                        <div class="schedule-time">${formatTime(b.scheduled_time)}</div>
                        <div class="schedule-info">
                            <div class="schedule-customer">${b.first_name} ${b.last_name}</div>
                            <div class="schedule-service">${b.service_name || 'Cleaning Service'}</div>
                            <div class="schedule-address">${b.address}, ${b.city}</div>
                        </div>
                        <div class="schedule-status">
                            <span class="badge badge-${b.status}">${b.status}</span>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                container.innerHTML = '<div class="error">Failed to load schedule</div>';
            }
        }
        
        async function loadRecentBookings() {
            const container = document.getElementById('recent-bookings');
            
            try {
                const { bookings } = await api('/api/admin/bookings?limit=5');
                
                if (bookings.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <h3>No bookings yet</h3>
                            <p>Bookings will appear here</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = bookings.map(b => `
                    <div class="booking-item">
                        <div class="booking-info">
                            <div class="booking-customer">${b.first_name} ${b.last_name}</div>
                            <div class="booking-meta">${formatDate(b.scheduled_date)} ¬∑ ${b.service_name || 'Cleaning'}</div>
                        </div>
                        <div class="booking-amount">${formatCurrency(b.total_amount)}</div>
                        <span class="badge badge-${b.status}">${b.status}</span>
                    </div>
                `).join('');
            } catch (err) {
                container.innerHTML = '<div class="error">Failed to load bookings</div>';
            }
        }
    </script>
</body>
</html>
